import os
import re
import csv


def process_txt_files_and_generate_csv(input_folder, output_csv):
    # Hardcoded section names
    section_names = [
        "SECTION 1: INTAKE/INITIAL RECEIPT",
        "SECTION 2: INVESTIGATION (PART ONE)",
        "SECTION 3: ADVERSE EVENT ASSESSMENT",
        "SECTION 4: INVESTIGATION (PART TWO)",
        "SECTION 5: REPORTABILITY AND ACTION"
    ]

    # Open the CSV file for writing
    with open(output_csv, 'w', newline='') as csvfile:
        csv_writer = csv.writer(csvfile)

        # Write the header row (file name + section names + Success indicator)
        csv_writer.writerow(["File Name"] + section_names + ["Success"])

        # Second pass: Extract data for each file
        for file_name in os.listdir(input_folder):
            if file_name.endswith('.txt'):
                file_path = os.path.join(input_folder, file_name)

                with open(file_path, 'r') as file:
                    content = file.read()

                # Initialize a dictionary for the section content (start with empty string for each section)
                section_data = {section: "" for section in section_names}

                # Loop through each section and extract associated content
                for section in section_names:
                    # Create the regex pattern to match the section content
                    start_pattern = re.escape(
                        section
                    ) + r"\s*\n"  # Match section name with optional whitespace
                    end_pattern = r"(SECTION \d+:|$)"  # Look for the next section or end of file
                    section_pattern = start_pattern + r"(.*?)" + end_pattern

                    # Search for the section content in the text
                    section_content = re.search(section_pattern, content,
                                                re.DOTALL)

                    # Debugging: Print out whether a match was found and the section content
                    if section_content:
                        section_data[section] = section_content.group(
                            1).strip()
                        print(f"Section matched for {section}:")
                        print(
                            section_data[section])  # Show the content captured
                    else:
                        section_data[section] = ""
                        print(
                            f"Section not found for {section}. Content is empty."
                        )

                # Prepare the row to write to the CSV
                row_data = [file_name] + [
                    section_data[section] for section in section_names
                ]

                # Add the "Success" indicator (1 for successful writing)
                row_data.append(1)

                # Write the row to the CSV file
                csv_writer.writerow(row_data)
                print(f"Data written for {file_name}.")

    print(f"Data successfully saved to {output_csv}")


# Input folder containing .txt files
input_folder = "txt_files"  # Replace with the folder where your .txt files are stored
output_csv = "output.csv"  # Replace with your desired output CSV file name

# Ensure the input folder exists
if not os.path.exists(input_folder):
    print(
        f"Folder '{input_folder}' does not exist. Please create it and add your .txt files."
    )
else:
    process_txt_files_and_generate_csv(input_folder, output_csv)
    print(f"CSV file generated: {output_csv}")
